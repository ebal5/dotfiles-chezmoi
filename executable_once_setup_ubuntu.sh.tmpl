#!/bin/bash
{{ if and (eq .chezmoi.os "linux") (eq .chezmoi.osRelease.id "ubuntu") }}
sudo apt update
sudo apt install -y \
  aria2 \
  autoconf \
  build-essential \
  cmake \
  curl \
  dirmngr \
  gawk \
  gettext \
  gpg \
  htop \
  httpie \
  libbz2-dev \
  libcurl4-openssl-dev \
  libdb-dev \
  libffi-dev \
  libgdbm-dev \
  liblzma-dev \
  libncursesw5-dev \
  libnotify-bin \
  libreadline-dev \
  libsqlite3-dev \
  libssl-dev \
  libz-dev \
  miller \
  nmap \
  protobuf-compiler \
  socat \
  tk-dev \
  unzip \
  uuid-dev \
  vim \
  zlib1g-dev

{{ if and (not (.chezmoi.kernel.osrelease | lower | contains "microsoft")) (.chezmoi.requireGUI) }}
# フォントなど独立したLinuxで必要とされるもの
sudo apt install -y \
  fonts-migmix \
  fonts-ipafont-gothic \
  fonts-ipafont-mincho
{{ end }}

# Install Nix
if ! command -v nix >/dev/null 2>&1; then
  curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install --no-confirm
  . "$HOME/.nix-profile/etc/profile.d/nix.sh"
fi

# Enable Nix flakes support
mkdir -p "$HOME/.config/nix"
if ! grep -q "experimental-features = nix-command flakes" "$HOME/.config/nix/nix.conf" 2>/dev/null; then
  echo "experimental-features = nix-command flakes" >> "$HOME/.config/nix/nix.conf"
fi

# Install tools via Nix flake (if flake.nix exists in dotfiles)
if [ -f "$HOME/.local/share/chezmoi/flake.nix" ]; then
  nix flake update "$HOME/.local/share/chezmoi" --no-write-lock-file 2>/dev/null || true
fi

if [ ! -x "$HOME/.local/bin/mise" ]; then
  gpg --keyserver hkps://keyserver.ubuntu.com --recv-keys 0x7413A06D
  curl https://mise.jdx.dev/install.sh.sig | gpg --decrypt > install.sh
  sh ./install.sh
  rm ./install.sh
fi
mise="$HOME/.local/bin/mise"
$mise use -yg bitwarden
$mise use -yg chezmoi
$mise use -yg git
$mise use -yg node
$mise use -yg python

# Bitwarden SSH Agent
git clone https://github.com/joaojacome/bitwarden-ssh-agent.git ~/.bw-ssh-agent
if ! cd ~/.bw-ssh-agent; then
  echo "Warning: Failed to change directory to ~/.bw-ssh-agent" >&2
else
  git checkout 6237a3604d640533ad4123d23e23ddfd4e3666d2 2>&1 > /dev/null
fi
if ! cd "$HOME"; then
  echo "Warning: Failed to change directory to $HOME" >&2
fi

{{ end }}
